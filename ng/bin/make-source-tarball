#!/bin/bash
#
# Copyright (c) 2017-present, Facebook, Inc.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree. An additional grant
# of patent rights can be found in the PATENTS file in the same directory.

set -ex

ROOT="$(realpath "$(dirname $0)/..")"
if [ "$ROOT" == "/opt/hhvm-packaging" ]; then
  OUT=/var/out
else
  OUT="$ROOT/out/"
fi
TEMPDIR="$(mktemp -d)"
VERSION=${VERSION:-"$(date +%Y.%m.%d)"}
TAR=${TAR:-tar}
cd "$TEMPDIR"
git clone https://github.com/facebook/hhvm.git hhvm-nightly-$VERSION
cd hhvm-nightly-$VERSION
git submodule update --init --recursive
find . -name '.git' | xargs rm -rf
cd ..
$TAR zcf "$OUT/hhvm-nightly-$VERSION.tar.gz" hhvm-nightly-$VERSION
cd /
rm -rf "$TEMPDIR"
