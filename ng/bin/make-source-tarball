#!/bin/bash
#
# Copyright (c) 2017-present, Facebook, Inc.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree. An additional grant
# of patent rights can be found in the PATENTS file in the same directory.

set -ex

ROOT="$(realpath "$(dirname $0)/..")"
if [ "$ROOT" == "/opt/hhvm-packaging" ]; then
  OUT=/var/out
else
  OUT="$ROOT/out/"
fi
TEMPDIR="$(mktemp -d)"
VERSION=${VERSION:-"$(date +%Y.%m.%d)"}
IS_NIGHTLY=${IS_NIGHTLY:-true}
TAR=${TAR:-tar}

cd "$TEMPDIR"

if $IS_NIGHTLY; then
  REPO=facebook/hhvm
  PREFIX=hhvm-nightly
  HEAD=master
else
  REPO=hhvm/hhvm-staging
  PREFIX=hhvm
  HEAD=HHVM-${VERSION}
fi

git clone https://github.com/${REPO}.git ${PREFIX}-${VERSION}
cd ${PREFIX}-$VERSION
git checkout $HEAD
git submodule update --init --recursive

# Delete stuff we dont' need
find . -name '.git' | xargs rm -rf
# ~ 500mb here
rm -rf third-party/webscalesqlclient/src/{rocksdb,xtrabackup,rqg,mysql-test}
# ~ 250mb here
rm -rf hphp/test/{slow,quick,zend,zend7}

cd ..
$TAR zcf "${OUT}/${PREFIX}-${VERSION}.tar.gz" "${PREFIX}-${VERSION}"
cd /
rm -rf "$TEMPDIR"
