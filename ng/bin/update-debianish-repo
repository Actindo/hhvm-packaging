#!/bin/bash
#
# Copyright (c) 2017-present, Facebook, Inc.
# All rights reserved.  #
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree. An additional grant
# of patent rights can be found in the PATENTS file in the same directory.

if [ "$1" != "debian" -a "$1" != "ubuntu" ]; then
  echo "USAGE: $0 debian|ubuntu"
  exit 1
fi

DISTRO_BASE="$1"
CONF_DIR="/opt/hhvm-packaging/repo-conf/$DISTRO_BASE"
REPO_DIR="/mnt/dl.hhvm.com/$DISTRO_BASE"
INCOMING_DIR="/var/hhvm-scratch"

if [ ! -d "$CONF_DIR" ]; then
  echo "Error: expected $CONF_DIR to exist."
  exit 1
fi

if [ ! -d "$REPO_DIR" ]; then
  echo "Error: expected $REPO_DIR to exist."
  exit 1
fi

if [ ! -d "$INCOMING_DIR" ]; then
  echo "Error: expected $INCOMING_DIR to exist."
  exit 1
fi

set -ex

cp "$CONF_DIR/distributions" "$REPO_DIR/conf/distributions"

for VERSION_DIR in "$INCOMING_DIR"/*; do
  VERSION=$(basename "$VERSION_DIR")
  for DISTRO_DIR in "$VERSION_DIR/$DISTRO_BASE-"*; do
    DISTRO=$(basename "$DISTRO_DIR")
    REPREPRO_DISTRO="$(<"/opt/hhvm-packaging/$DISTRO/DISTRIBUTION")"
    (
      cd "$REPO_DIR"
      reprepro include "$REPREPRO_DISTRO" "$DISTRO_DIR"/*.changes
      aws s3 rm --recursive s3://hhvm-scratch/$VERSION/$DISTRO
    )
  done
done

aws s3 sync "$REPO_DIR/" "s3://hhvm-downloads/${DISTRO_BASE}/"
