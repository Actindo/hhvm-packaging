#!/bin/bash
#
# Copyright (c) 2017-present, Facebook, Inc.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree. An additional grant
# of patent rights can be found in the PATENTS file in the same directory.

set -e

ROOT="$(realpath "$(dirname $0)/..")"
VERSION=${VERSION:-"$(date +%Y.%m.%d)"}
if [ -z "$DISTRO" ]; then
  echo "Environment variable DISTRO must be set"
  exit 1
fi

UBUNTU_16_04_AMI=ami-6e1a0117
INSTANCE_TYPE=c4.2xlarge # 8 cores, 15GB of RAM
KEYPAIR="Fred's GPG Key"

INIT_SCRIPT=$(mktemp -t hhvm-aws-init-script)
cat > $INIT_SCRIPT <<EOF
#!/bin/bash
VERSION=${VERSION}
DISTRO=${DISTRO}
EOF
cat "$ROOT/aws/make-binary-package.userdata.sh" >> $INIT_SCRIPT

aws ec2 run-instances \
  --region us-west-2 \
  --image-id $UBUNTU_16_04_AMI \
  --instance-type $INSTANCE_TYPE \
  --security-groups hhvm-binary-package-builders \
  --instance-initiated-shutdown-behavior terminate \
  --iam-instance-profile "Arn=arn:aws:iam::223121549624:instance-profile/hhvm-binary-package-builder" \
  --key-name "$KEYPAIR" \
  --block-device-mapping="DeviceName=/dev/sda1,VirtualName=,Ebs={VolumeSize=100,VolumeType=gp2,DeleteOnTermination=true}" \
  --user-data "file://${INIT_SCRIPT}" \
  --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=hhvm-build-$VERSION-$DISTRO}]"

rm "${INIT_SCRIPT}"
